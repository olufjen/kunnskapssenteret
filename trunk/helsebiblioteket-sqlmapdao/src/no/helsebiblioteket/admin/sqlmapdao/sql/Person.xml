<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap
	PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
	"http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="Person">
	<typeAlias alias="person" type="no.helsebiblioteket.admin.domain.Person"/>
	<cacheModel id="PersonCache" type="LRU" readOnly="false" serialize="true">
		<flushInterval hours="24"/>
		<flushOnExecute statement="insertPerson"/>
		<flushOnExecute statement="updatePerson"/>
		<flushOnExecute statement="deletePerson"/>
		<property name="size" value="1000" />
	</cacheModel>
	<resultMap id="getPersonResultMap" class="person">
		<result property="id" column="person_id" />
		<result property="firstName" column="first_name" />
		<result property="lastName" column="last_name" />
		<result property="studentNumber" column="student_number" />
		<result property="hprNumber" column="hpr_number" />
		<result property="contactInformation.id" column="contact_information_id" />
		<result property="profile.id" column="profile_id" />
		<result property="position.id" column="position_type_id" />
		<result property="lastChanged" column="last_changed" />
	</resultMap>
	<insert id="insertPerson" parameterClass="person">
		<selectKey resultClass="int" keyProperty="id">
			SELECT nextval('tbl_person_person_id_seq') as id;
		</selectKey>
		insert into tbl_person
		(person_id, first_name, last_name, student_number, hpr_number, contact_information_id, profile_id, position_type_id, last_changed)
		values 
		(#id#, #firstName#, #lastName#, #studentNumber#, #hprNumber#, #contactInformation.id#, #profile.id#, #position.id#, now());
	</insert>
	<update id="updatePerson" parameterClass="person">
		update tbl_person set
			first_name = #firstName#,
			last_name = #lastName#,
			student_number = #studentNumber#,
			hpr_number = #hprNumber#,
			contact_information_id = #contactInformation.id#,
			profile_id = #profile.id#,
			position_type_id = #position.id#,
			last_changed = now()
		where
			person_id = #id# and last_changed = #lastChanged#;
	</update>
	<delete id="deletePerson" parameterClass="person">
  		delete from tbl_person where person_id = #id#
    </delete>
	<select id="getPersonById" cacheModel="PersonCache" resultMap="getPersonResultMap" parameterClass="integer">
		select person_id, first_name, last_name, student_number, hpr_number, contact_information_id, profile_id, position_type_id, last_changed
		from tbl_person
		where person_id = #id#;
	</select>
	<select id="getPersonByUserId" cacheModel="PersonCache" resultMap="getPersonResultMap" parameterClass="integer">
		select person_id, first_name, last_name, student_number, hpr_number, contact_information_id, profile_id, position_type_id, last_changed
		from tbl_person
		where person_id = (select person_id from tbl_user where user_id = #userId#);
	</select>
	<select id="getPersonByOrganizationId" cacheModel="PersonCache" resultMap="getPersonResultMap" parameterClass="integer">
		select person_id, first_name, last_name, student_number, hpr_number, contact_information_id, profile_id, position_type_id, last_changed
		from tbl_person
		where person_id = (select person_id from tbl_org_unit where org_unit_id = #id#);
	</select>
</sqlMap>
