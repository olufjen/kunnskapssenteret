<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap
	PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
	"http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="Person">
	<typeAlias alias="person" type="no.helsebiblioteket.admin.domain.Person"/>
	<select id="getPersonById" resultClass="person" parameterClass="integer">
		select *
		from tlb_person
		where person_id = #personId#;
	</select>
	<select id="getPersonList" resultClass="person">
		select 
		person_id as id, 
		first_name as firstName, 
		last_name as lastName, 
		student_number as studentNumber, 
		hpr_number as hprNumber, 
		contact_information_id as "contactInformation.id", 
		profile_id as "profile.id", 
		position_type_id as "positionType.id", 
		last_changed as lastChanged
		from
		tbl_person;
	</select>
	<insert id="insertPerson" parameterClass="person">
		<selectKey resultClass="int" keyProperty="personId">
			SELECT nextval('tbl_person_person_id_seq') as person_id;
		</selectKey>
		insert into person
		(person_id, 
		first_name, 
		last_name, 
		student_number, 
		hpr_number, 
		contact_information_id, 
		profile_id, 
		position_type_id, 
		last_changed) 
		values 
		(#personId#, 
		#firstName#, 
		#lastName#, 
		#studentNumber#, 
		#hprNumber#, 
		#contactInformation.id#, 
		#profile.id#, 
		#position.id#, 
		now());
	</insert>
	<update id="updatePerson" parameterClass="person">
		update person
		set first_name = #firstName#
		last_name = #lastName#
		student_number = #studentNumber#
		hpr_number = #hprNumber#
		contact_information_id = #contact_information_id#
		profile_id = #profile_id#
		position_type_id = #position_type_id#
		last_changed = now()
		where person_id = #id# and 
    	last_changed = #lastChanged#;
	</update>
</sqlMap>