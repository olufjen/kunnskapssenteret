<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap
	PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
	"http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="Access">
	<typeAlias alias="ResourceAccessForeignKeys" type="no.helsebiblioteket.admin.dao.keys.ResourceAccessForeignKeys"/>

	<cacheModel id="AccessCache" type="LRU" readOnly="false" serialize="true">
		<flushInterval hours="24"/>
		<flushOnExecute statement="insertResourceAccessForeignKeys"/>
		<flushOnExecute statement="updateResourceAccessForeignKeys"/>
		<flushOnExecute statement="deleteResourceAccessForeignKeys"/>
		<property name="size" value="1000" />
	</cacheModel>
	<resultMap id="ResourceAccessResultMap" class="ResourceAccessForeignKeys">
		<result property="resourceAccess.access.accessType.id" column="access_type_id" />
		<result property="userId" column="user_id" />
		<result property="userRoleId" column="user_role_id" />
		<result property="resourceAccess.access.validFrom" column="valid_from" />
		<result property="resourceAccess.access.validTo" column="valid_to" />
		<result property="resourceAccess.access.id" column="access_id" />
		<result property="resourceAccess.resource.resource.id" column="resource_id" />
		<result property="orgTypeId" column="org_type_id" />
		<result property="resourceAccess.access.providedBy.organization.id" column="provided_by_org_unit" />
		<result property="orgUnitId" column="org_unit_id" />
		<result property="resourceAccess.access.lastChanged" column="last_changed" />
	</resultMap>

	<insert id="insertResourceAccessForeignKeys" parameterClass="ResourceAccessForeignKeys">
		<selectKey resultClass="int" keyProperty="resourceAccess.access.id">
			SELECT nextval('tbl_access_access_id_seq') as id;
		</selectKey>
		insert into tbl_access (
			access_type_id, 
			user_id, 
			user_role_id, 
			valid_from, 
			valid_to, 
			access_id, 
			resource_id, 
			org_type_id, 
			provided_by_org_unit,
			org_unit_id, 
			last_changed
			)
		values (#resourceAccess.access.accessType.id#,
				#userId#,
				#userRoleId#,
				#resourceAccess.access.validFrom#,
				#resourceAccess.access.validTo#,
				#resourceAccess.access.id#,
				#resourceAccess.resource.resource.id#,
				#orgTypeId#,
				#resourceAccess.access.providedBy.organization.id#,
				#orgUnitId#, now());
	</insert>
	<update id="updateResourceAccessForeignKeys" parameterClass="ResourceAccessForeignKeys">
		update tbl_access set
			access_type_id = #resourceAccess.access.accessType.id#,
			user_id = #userId#, 
			user_role_id = #userRoleId#, 
			valid_from = #resourceAccess.access.validFrom#,
			valid_to = #resourceAccess.access.validTo#,
			access_id = #resourceAccess.access.id#,
			resource_id = #resourceAccess.resource.resource.id#,
			org_type_id = #orgTypeId#,
			provided_by_org_unit = #resourceAccess.access.providedBy.organization.id#,
			org_unit_id = #orgUnitId#, 
			last_changed = now()
		where access_id = #resourceAccess.access.id# and last_changed = #resourceAccess.access.lastChanged#
	</update>
	<delete id="deleteResourceAccessForeignKeys" parameterClass="ResourceAccessForeignKeys">
  		delete from tbl_access
  		where
  		access_id = #resourceAccess.access.id# and last_changed = #resourceAccess.access.lastChanged#
    </delete>

	<select id="getResourceAccessForeignKeysByAccessId" cacheModel="AccessCache" resultMap="ResourceAccessResultMap" parameterClass="integer">
		select access_type_id, 
			user_id, 
			user_role_id, 
			valid_from, 
			valid_to, 
			access_id, 
			resource_id, 
			org_type_id, 
			provided_by_org_unit,
			org_unit_id, 
			last_changed
		from tbl_access
		where access_id = #id#;
	</select>

	<select id="getAccessListByUserId" cacheModel="AccessCache" resultMap="ResourceAccessResultMap" parameterClass="integer">
		select access_type_id, 
			user_id, 
			user_role_id, 
			valid_from, 
			valid_to, 
			access_id, 
			resource_id, 
			org_type_id, 
			provided_by_org_unit,
			org_unit_id, 
			last_changed
		from tbl_access
		where user_id = #userId#;
	</select>
	<select id="getAccessListByOrganizationId" cacheModel="AccessCache" resultMap="ResourceAccessResultMap" parameterClass="integer">
		select access_type_id, 
			user_id, 
			user_role_id, 
			valid_from, 
			valid_to, 
			access_id, 
			resource_id, 
			org_type_id, 
			provided_by_org_unit,
			org_unit_id, 
			last_changed
		from tbl_access
		where org_unit_id = #organizationId#;
	</select>
	<select id="getAccessListByOrganizationType" cacheModel="AccessCache" resultMap="ResourceAccessResultMap" parameterClass="integer">
		select access_type_id, 
			user_id, 
			user_role_id, 
			valid_from, 
			valid_to, 
			access_id, 
			resource_id, 
			org_type_id, 
			provided_by_org_unit,
			org_unit_id, 
			last_changed
		from tbl_access
		where org_type_id = #organizationTypeId#;
	</select>
	<select id="getAccessListByUserRole" cacheModel="AccessCache" resultMap="ResourceAccessResultMap" parameterClass="integer">
		select access_type_id, 
			user_id, 
			user_role_id, 
			valid_from, 
			valid_to, 
			access_id, 
			resource_id, 
			org_type_id, 
			provided_by_org_unit,
			org_unit_id, 
			last_changed
		from tbl_access
		where user_role_id = #userRoleId#;
	</select>

</sqlMap>
