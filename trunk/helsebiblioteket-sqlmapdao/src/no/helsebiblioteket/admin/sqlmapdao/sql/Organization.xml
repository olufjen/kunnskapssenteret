<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap
	PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
	"http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="organization">
	<typeAlias alias="Organization" type="no.helsebiblioteket.admin.domain.Organization"/>
	<typeAlias alias="MemberOrganization" type="no.helsebiblioteket.admin.domain.MemberOrganization"/>
	<typeAlias alias="SupplierOrganization" type="no.helsebiblioteket.admin.domain.SupplierOrganization"/>

	<resultMap id="OrganizationMap" class="Organization">
		<result property="id" column="org_unit_id" />
		<result property="description" column="descr" />
		<result property="type.id" column="org_type_id" />
		<result property="contactInformation.id" column="contact_information_id" />
		<result property="supportInformation.id" column="support_information_id" />
		<result property="contactPerson.id" column="person_id" />
		<result property="lastChanged" column="last_changed" />
	</resultMap>
	<resultMap id="SupplierOrganizationMap" class="SupplierOrganization">
		<result property="organization.id" column="org_unit_id" />
		<result property="organization.description" column="descr" />
		<result property="organization.type.id" column="org_type_id" />
		<result property="organization.contactInformation.id" column="contact_information_id" />
		<result property="organization.supportInformation.id" column="support_information_id" />
		<result property="organization.contactPerson.id" column="person_id" />
		<result property="organization.lastChanged" column="last_changed" />
	</resultMap>
	<insert id="insertOrganization" parameterClass="Organization">
		<selectKey resultClass="int" keyProperty="id">
			SELECT nextval('tbl_org_unit_org_unit_id_seq') as id;
		</selectKey>
		insert into tbl_org_unit (org_unit_id, descr, org_type_id, contact_information_id, support_information_id, person_id, last_changed) 
		values (#id#, #description#, #type.id#, #contactInformation.id#, #supportInformation.id#, #contactPerson.id#, now());
	</insert>
	<insert id="insertSupplierOrganization" parameterClass="SupplierOrganization">
		<selectKey resultClass="int" keyProperty="organization.id">
			SELECT nextval('tbl_org_unit_org_unit_id_seq') as id;
		</selectKey>
		insert into tbl_org_unit (org_unit_id, descr, org_type_id, contact_information_id, support_information_id, person_id, last_changed) 
		values (#organization.id#, #organization.description#, #organization.type.id#, #organization.contactInformation.id#, #organization.supportInformation.id#, #organization.contactPerson.id#, now());
	</insert>
	<update id="updateOrganization" parameterClass="Organization">
		update tbl_org_unit set
			descr = #description#,
      		org_type_id = #type.id#,
	      	contact_information_id = #contactInformation.id#,
	      	support_information_id = #supportInformation.id#,
    	  	person_id = #contactPerson.id#,
      		last_changed = now()
    	where org_unit_id = #id# and last_changed = #lastChanged#;
  	</update>
	<update id="updateSupplierOrganization" parameterClass="SupplierOrganization">
		update tbl_org_unit set
			descr = #organization.description#,
      		org_type_id = #organization.type.id#,
	      	contact_information_id = #organization.contactInformation.id#,
	      	support_information_id = #organization.supportInformation.id#,
    	  	person_id = #organization.contactPerson.id#,
      		last_changed = now()
    	where org_unit_id = #organization.id# and last_changed = #organization.lastChanged#;
  	</update>
	<delete id="deleteOrganization" parameterClass="Organization">
  		delete from tbl_org_unit where org_unit_id = #id# and last_changed = #lastChanged#
    </delete>
	<select id="getOrganizationById" resultMap="OrganizationMap" parameterClass="integer">
		select org_unit_id, descr, org_type_id, contact_information_id, support_information_id, person_id, last_changed
		from tbl_org_unit
		where org_unit_id = #organizationId#;
	</select>
	<select id="getSupplierOrganizationById" resultMap="SupplierOrganizationMap" parameterClass="integer">
		select org_unit_id, descr, org_type_id, contact_information_id, support_information_id, person_id, last_changed
		from tbl_org_unit
		where org_unit_id = #organizationId#;
	</select>
</sqlMap>
