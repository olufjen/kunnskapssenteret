<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap
	PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
	"http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="Action">
	<typeAlias alias="ActionLine" type="no.helsebiblioteket.admin.domain.line.ActionLine"/>

	<cacheModel id="ActionCache" type="LRU" readOnly="false" serialize="true">
		<flushInterval hours="24"/>
		<flushOnExecute statement="insertAction"/>
		<flushOnExecute statement="updateAction"/>
		<flushOnExecute statement="deleteAction"/>
		<property name="size" value="1000" />
	</cacheModel>
	
	<resultMap id="ActionLineMap" class="ActionLine">
		<result property="id" column="action_id" />
		<result property="userId" column="user_id" />
		<result property="resourceId" column="resource_id" />
		<result property="orgUnitId" column="org_unit_id" />
		<result property="actionPerformed" column="action_performed" />
		<result property="accessTypeId" column="access_type_id" />
	</resultMap>
	
	<insert id="insertAction" parameterClass="ActionLine">
		<selectKey resultClass="int" keyProperty="id">
			SELECT nextval('tbl_action_action_id_seq') as id;
		</selectKey>
		insert into tbl_action (
			action_id,
			action_performed,
			user_id,
			resource_id,
			org_unit_id,
			access_type_id
		) values (
			#id#,
			now(),
			#userId#,
			#resourceId#,
			#orgUnitId#,
			#accessTypeId#
		);
	</insert>
	<update id="updateAction" parameterClass="ActionLine">
		update tbl_action set
			action_id = #id#,
			action_performed = now(),
			user_id = #userId#,
			resource_id = #resourceId#,
			org_unit_id = #orgUnitId#,
			access_type_id = #accessTypeId#
		where
			action_id = #id# and action_performed = #actionPerformed#
	</update>
	<delete id="deleteAction" parameterClass="ActionLine">
  		delete from tbl_action where action_id = #id# and action_performed = #actionPerformed#
    </delete>
	<select id="getActionLineByActionId" cacheModel="ActionCache" resultMap="ActionLineMap" parameterClass="integer">
		select
			action_id,
			action_performed,
			user_id,
			resource_id,
			org_unit_id,
			access_type_id
		from
			tbl_action
		where
			action_id = #id#;
	</select>
	<select id="getActionListByUserId" cacheModel="ActionCache" resultMap="ActionLineMap" parameterClass="integer">
		select
			action_id,
			action_performed,
			user_id,
			resource_id,
			org_unit_id,
			access_type_id
		from
			tbl_action
		where
			user_id = #id#;
	</select>
	<select id="getActionListByOrganizationId" cacheModel="ActionCache" resultMap="ActionLineMap" parameterClass="integer">
		select
			action_id,
			action_performed,
			user_id,
			resource_id,
			org_unit_id,
			access_type_id
		from
			tbl_action
		where
			org_unit_id = #id#;
	</select>
	<select id="getActionListByResourceId" cacheModel="ActionCache" resultMap="ActionLineMap" parameterClass="integer">
		select
			action_id,
			action_performed,
			user_id,
			resource_id,
			org_unit_id,
			access_type_id
		from
			tbl_action
		where
			resource_id = #id#;
	</select>
	<select id="getActionListByAccessTypeId" cacheModel="ActionCache" resultMap="ActionLineMap" parameterClass="integer">
		select
			action_id,
			action_performed,
			user_id,
			resource_id,
			org_unit_id,
			access_type_id
		from
			tbl_action
		where
			access_type_id = #id#;
	</select>
</sqlMap>
