<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap
	PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
	"http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="Resource">
	<typeAlias alias="SupplierSourceResource" type="no.helsebiblioteket.admin.domain.SupplierSourceResource" />
	<resultMap id="SupplierSourceResourceResultMap" class="SupplierSourceResource">
		<result property="resource.id" column="resource_id" />
		<result property="supplierSource.id" column="supplier_source_id" />
		<result property="resource.resourceType.id" column="resource_type_id" />
		<result property="resource.offeredBy" column="org_unit_id" />
		<result property="resource.deleted" column="deleted" />
		<result property="resource.lastChanged" column="last_changed" />
	</resultMap>
	<resultMap id="SupplierSourceResourceResultListMap" class="SupplierSourceResource">
		<result property="resource.id" column="resource_id" />
		<result property="supplierSource.id" column="supplier_source_id" />
		<result property="supplierSource.supplierSourceName" column="supplier_source_name" />
		<result property="supplierSource.proxyDatabaseName" column="proxy_database_name" />
		<result property="supplierSource.url.domain" column="domain" />
		<result property="resource.resourceType.id" column="resource_type_id" />
		<result property="resource.resourceType.key.value" column="key" />
		<result property="resource.resourceType.description" column="descr" />
		<result property="resource.resourceType.name" column="name" />
		<result property="resource.offeredBy" column="org_unit_id" />
		<result property="resource.deleted" column="deleted" />
		<result property="resource.lastChanged" column="last_changed" />
	</resultMap>
	<insert id="insertSupplierSourceResource" parameterClass="SupplierSourceResource">
		<selectKey resultClass="int" keyProperty="resource.id">
			SELECT nextval('tbl_resource_resource_id_seq') as id;
		</selectKey>
		insert into tbl_resource (resource_id, supplier_source_id, resource_type_id, org_unit_id, deleted, last_changed)
		values (#resource.id#, #supplierSource.id#, #resource.resourceType.id#, #resource.offeredBy#, #resource.deleted#, date_trunc('milliseconds', now()));
	</insert>
	<update id="updateSupplierSourceResource" parameterClass="SupplierSourceResource">
		update tbl_resource set
      		supplier_source_id = #supplierSource.id#,
      		resource_type_id = #resource.resourceType.id#,
	      	org_unit_id = #resource.offeredBy#,
	      	deleted = #resource.deleted#,
    	  	last_changed = date_trunc('milliseconds', now())
    	where resource_id = #resource.id# and date_trunc('milliseconds', last_changed) = #resource.lastChanged#;
	</update>
	<delete id="deleteSupplierSourceResource" parameterClass="SupplierSourceResource">
		delete from tbl_resource
		where resource_id = #resource.id# 
		and date_trunc('milliseconds', last_changed) = #resource.lastChanged#;
	</delete>
	<select id="getSupplierSourceResourceById" resultMap="SupplierSourceResourceResultListMap" parameterClass="integer">
		select
			sup.supplier_source_name,
			sup.proxy_database_name,
			sup.domain,
			type.key,
			type.descr,
			type.name,
			res.resource_id,
			date_trunc('milliseconds', res.last_changed) as last_changed,
			res.deleted,
			sup.supplier_source_id,
			type.resource_type_id,
			org_unit_id
		from tbl_resource as res
			inner join tbl_supplier_source as sup on res.supplier_source_id = sup.supplier_source_id
			inner join tbl_resource_type_reg as type on res.resource_type_id = type.resource_type_id
		where
			res.resource_id = #id#
			and res.deleted is false;
	</select>
	<select id="getSupplierSourceResourceByOrganizationId" resultMap="SupplierSourceResourceResultListMap" parameterClass="integer">
		select
			sup.supplier_source_name,
			sup.domain,
			sup.proxy_database_name,
			type.key,
			type.descr,
			type.name,
			res.resource_id,
			date_trunc('milliseconds', res.last_changed) as last_changed,
			res.deleted,
			sup.supplier_source_id,
			type.resource_type_id,
			org_unit_id
		from tbl_resource as res
			inner join tbl_supplier_source as sup on res.supplier_source_id = sup.supplier_source_id
			inner join tbl_resource_type_reg as type on res.resource_type_id = type.resource_type_id
		where
			res.org_unit_id = #id# and res.deleted is false;
	</select>
	
	<select id="getSupplierSourceResourcesAll" resultMap="SupplierSourceResourceResultListMap">
		select
			sup.supplier_source_name,
			sup.proxy_database_name,
			sup.domain,
			type.key,
			type.descr,
			type.name,
			res.resource_id,
			date_trunc('milliseconds', res.last_changed) as last_changed,
			res.deleted,
			sup.supplier_source_id,
			type.resource_type_id,
			org_unit_id
		from tbl_resource as res
			inner join tbl_supplier_source as sup on res.supplier_source_id = sup.supplier_source_id
			inner join tbl_resource_type_reg as type on res.resource_type_id = type.resource_type_id
		where
			res.deleted is false;
	</select>

</sqlMap>
