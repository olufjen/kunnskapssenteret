<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap
	PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
	"http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="User">
	<typeAlias alias="user" type="no.helsebiblioteket.admin.domain.OrganizationUser"/>
	<resultMap id="getUserResultMap" class="user">
		<result property="user.id" column="user_id" />
		<result property="user.username" column="username" />
		<result property="user.password" column="password" />
		<result property="user.deleted" column="deleted" />
		<result property="organization.id" column="org_unit_id" />
		<result property="user.person.id" column="person_id" />
		<result property="user.orgAdminFor.id" column="admin_org_unit_id" />
		<result property="user.lastChanged" column="last_changed" />
	</resultMap>
	
	<insert id="insertUser" parameterClass="user">
		<selectKey resultClass="int" keyProperty="user.id">
			SELECT nextval('tbl_user_user_id_seq') as id;
		</selectKey>
		insert into tbl_user
			(user_id, username, password, org_unit_id, person_id, admin_org_unit_id, last_changed)
		values 
			(#user.id#, #user.username#, #user.password#, #organization.id#, #user.person.id#, #user.orgAdminFor.id#, date_trunc('milliseconds', now()));
	</insert>
	<update id="updateUser" parameterClass="user">
		update tbl_user set
			username = #user.username#,
			password = #user.password#,
			deleted = #user.deleted#,
			org_unit_id = #organization.id#,
			person_id = #user.person.id#,
			admin_org_unit_id = #user.orgAdminFor.id#,
			last_changed = date_trunc('milliseconds', now())
		where user_id = #user.id# and date_trunc('milliseconds', last_changed) = #user.lastChanged#;
	</update>
	<select id="getUserByUsername" resultMap="getUserResultMap" parameterClass="string">
		select user_id, deleted, username, password, org_unit_id, person_id, admin_org_unit_id, date_trunc('milliseconds', last_changed) as last_changed
		from tbl_user
		where username = #userName# and deleted is false;
	</select>
	<select id="getUserById" resultMap="getUserResultMap" parameterClass="integer">
		select user_id, deleted, username, password, org_unit_id, person_id, admin_org_unit_id, date_trunc('milliseconds', last_changed) as last_changed
		from tbl_user
		where user_id = #id#;
	</select>
</sqlMap>
