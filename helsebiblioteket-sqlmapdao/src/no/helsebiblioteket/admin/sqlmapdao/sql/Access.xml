<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap
	PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
	"http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="Access">
	<typeAlias alias="ResourceAccessForeignKeys" type="no.helsebiblioteket.admin.dao.keys.ResourceAccessForeignKeys"/>
	<typeAlias alias="ResourceAccessListItem" type="no.helsebiblioteket.admin.domain.list.ResourceAccessListItem"/>
	<typeAlias alias="Resource" type="no.helsebiblioteket.admin.domain.Resource"/>

	<resultMap id="ResourceAccessResultMap" class="ResourceAccessForeignKeys">
		<result property="resourceAccess.access.accessType.id" column="access_type_id" />
		<result property="userId" column="user_id" />
		<result property="userRoleId" column="user_role_id" />
		<result property="resourceAccess.access.validFrom" column="valid_from" />
		<result property="resourceAccess.access.validTo" column="valid_to" />
		<result property="resourceAccess.access.id" column="access_id" />
		<result property="resourceAccess.resource.resource.id" column="resource_id" />
		<result property="orgTypeId" column="org_type_id" />
		<result property="resourceAccess.access.providedBy.organization.id" column="provided_by_org_unit" />
		<result property="orgUnitId" column="org_unit_id" />
		<result property="resourceAccess.access.lastChanged" column="last_changed" />
		<result property="resourceAccess.access.deleted" column="deleted" />
	</resultMap>
	<resultMap id="ResourceAccessListItemResultMap" class="ResourceAccessListItem">
		<result property="id" column="access_id" />
		<result property="category.value" column="category" />
		<result property="key.value" column="key" />
		<result property="url.stringValue" column="url" />
		<result property="lastChanged" column="last_changed" />
		<result property="supplierSourceName" column="supplier_source_name" />
		<result property="providedBy" column="provided_by_org_unit" />
		<result property="resourceId" column="resource_id" />
		<result property="supplierSourceId" column="supplier_source_id" />
	</resultMap>

	<insert id="insertResourceAccessForeignKeys" parameterClass="ResourceAccessForeignKeys">
		<selectKey resultClass="int" keyProperty="resourceAccess.access.id">
			SELECT nextval('tbl_access_access_id_seq') as id;
		</selectKey>
		insert into tbl_access (
			access_type_id, 
			user_id, 
			user_role_id, 
			valid_from, 
			valid_to, 
			access_id, 
			resource_id, 
			org_type_id, 
			provided_by_org_unit,
			org_unit_id,
			deleted,
			last_changed
			)
		values (#resourceAccess.access.accessType.id#,
				#userId#,
				#userRoleId#,
				#resourceAccess.access.validFrom#,
				#resourceAccess.access.validTo#,
				#resourceAccess.access.id#,
				#resourceAccess.resource.resource.id#,
				#orgTypeId#,
				#resourceAccess.access.providedBy.organization.id#,
				#resourceAccess.access.deleted#,
				#orgUnitId#, now());
	</insert>
	<update id="updateResourceAccessForeignKeys" parameterClass="ResourceAccessForeignKeys">
		update tbl_access set
			access_type_id = #resourceAccess.access.accessType.id#,
			user_id = #userId#, 
			user_role_id = #userRoleId#, 
			valid_from = #resourceAccess.access.validFrom#,
			valid_to = #resourceAccess.access.validTo#,
			access_id = #resourceAccess.access.id#,
			resource_id = #resourceAccess.resource.resource.id#,
			org_type_id = #orgTypeId#,
			provided_by_org_unit = #resourceAccess.access.providedBy.organization.id#,
			org_unit_id = #orgUnitId#,
			deleted = #resourceAccess.access.deleted#,
			last_changed = now()
		where access_id = #resourceAccess.access.id# and last_changed = #resourceAccess.access.lastChanged#
	</update>
	<delete id="deleteResourceAccessForeignKeys" parameterClass="ResourceAccessForeignKeys">
  		delete from tbl_access
  		where
  		access_id = #resourceAccess.access.id# and last_changed = #resourceAccess.access.lastChanged#
    </delete>

	<select id="getResourceAccessForeignKeysByAccessId" resultMap="ResourceAccessResultMap" parameterClass="integer">
		select access_type_id, 
			user_id, 
			user_role_id, 
			valid_from, 
			valid_to, 
			access_id, 
			resource_id, 
			org_type_id, 
			provided_by_org_unit,
			org_unit_id,
			deleted, 
			last_changed
		from tbl_access
		where access_id = #id#;
	</select>

	<select id="getAccessListForAll" resultMap="ResourceAccessListItemResultMap" >
		select
			access_id,
			category,
			key,
			url,
			tbl_access.last_changed as last_changed,
			supplier_source_name,
			provided_by_org_unit,
			tbl_resource.resource_id,
			tbl_supplier_source.supplier_source_id
		from tbl_access
			inner join tbl_access_type_reg on tbl_access.access_type_id = tbl_access_type_reg.access_type_id
			inner join tbl_resource on tbl_access.resource_id = tbl_resource.resource_id
			inner join tbl_supplier_source on tbl_resource.supplier_source_id = tbl_supplier_source.supplier_source_id
		where
			category = 'GRANT' and
			(key = 'proxy_include_all' or key = 'proxy_exclude_all') and
			tbl_access.deleted is false;
	</select>

	<select id="getAccessListByUserId" resultMap="ResourceAccessListItemResultMap" parameterClass="integer">
		select
			access_id,
			category,
			key,
			url,
			tbl_access.last_changed as last_changed,
			supplier_source_name,
			provided_by_org_unit,
			tbl_resource.resource_id,
			tbl_supplier_source.supplier_source_id
		from tbl_access
			inner join tbl_access_type_reg on tbl_access.access_type_id = tbl_access_type_reg.access_type_id
			inner join tbl_resource on tbl_access.resource_id = tbl_resource.resource_id
			inner join tbl_supplier_source on tbl_resource.supplier_source_id = tbl_supplier_source.supplier_source_id
		where user_id = #userId# and tbl_access.deleted is false;
	</select>
	<select id="getAccessListByOrganizationId" resultMap="ResourceAccessListItemResultMap" parameterClass="integer">
		select
			access_id,
			category,
			key,
			url,
			tbl_access.last_changed as last_changed,
			supplier_source_name,
			provided_by_org_unit,
			tbl_resource.resource_id,
			tbl_supplier_source.supplier_source_id
		from tbl_access
			inner join tbl_access_type_reg on tbl_access.access_type_id = tbl_access_type_reg.access_type_id
			inner join tbl_resource on tbl_access.resource_id = tbl_resource.resource_id
			inner join tbl_supplier_source on tbl_resource.supplier_source_id = tbl_supplier_source.supplier_source_id
		where tbl_access.org_unit_id = #organizationId# and tbl_access.deleted is false;
	</select>
	<select id="getAccessListByOrganizationType" resultMap="ResourceAccessListItemResultMap" parameterClass="integer">
		select
			access_id,
			category,
			key,
			url,
			tbl_access.last_changed as last_changed,
			supplier_source_name,
			provided_by_org_unit,
			tbl_resource.resource_id,
			tbl_supplier_source.supplier_source_id
		from tbl_access
			inner join tbl_access_type_reg on tbl_access.access_type_id = tbl_access_type_reg.access_type_id
			inner join tbl_resource on tbl_access.resource_id = tbl_resource.resource_id
			inner join tbl_supplier_source on tbl_resource.supplier_source_id = tbl_supplier_source.supplier_source_id
		where org_type_id = #organizationTypeId# and tbl_access.deleted is false;
	</select>
	<select id="getAccessListByUserRole" resultMap="ResourceAccessListItemResultMap" parameterClass="integer">
		select
			access_id,
			category,
			key,
			url,
			tbl_access.last_changed as last_changed,
			supplier_source_name,
			provided_by_org_unit,
			tbl_resource.resource_id,
			tbl_supplier_source.supplier_source_id
		from tbl_access
			inner join tbl_access_type_reg on tbl_access.access_type_id = tbl_access_type_reg.access_type_id
			inner join tbl_resource on tbl_access.resource_id = tbl_resource.resource_id
			inner join tbl_supplier_source on tbl_resource.supplier_source_id = tbl_supplier_source.supplier_source_id
		where user_role_id = #userRoleId# and tbl_access.deleted is false;
	</select>
	<select id="getAccessListByResource" resultMap="ResourceAccessResultMap" parameterClass="Resource">
		select access_type_id, 
			user_id, 
			user_role_id, 
			valid_from, 
			valid_to, 
			access_id, 
			resource_id, 
			org_type_id, 
			provided_by_org_unit,
			org_unit_id,
			deleted, 
			last_changed
		from tbl_access
		where resource_id = #id#;
	</select>
</sqlMap>
